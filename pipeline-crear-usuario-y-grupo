pipeline {
    agent any
    parameters {
        string(name: 'login', defaultValue: '', description: 'Ingresa el login')
        string(name: 'nombre-apellido', defaultValue: '', description: 'Ingresa el Nombre y Apellido')
        string(name: 'departamento', defaultValue: '', description: 'Ingresa el grupo del usuario')
    }
     environment {
        password = "123456789*"
    }
    stages {
        stage('Crear Usuario y Grupo') {
            steps {
                script {
   
                    def login = params.login
                    def nombreApellido = params.'nombre-apellido'
                    def departamento = params.departamento

                    def userExists = sh(script: "getent passwd $login > /dev/null 2>&1", returnStatus: true)

                    if (userExists == 0) {
                        currentBuild.result = 'SUCCESS'
                        echo "El usuario $login ya existe. No se realizó ninguna modificación."
                    } else {
                        // Si el usuario no existe, lo creamos
                        echo "Creando el usuario: $login"
                        sh """
                            sudo useradd -m -s /bin/bash -c '$nombreApellido' -g $departamento $login
                            echo "$login:${env.password}" | sudo chpasswd
                            sudo passwd -e $login
                        """
                        currentBuild.result = 'SUCCESS'
                        echo "Usuario ${login} fue creado con éxito. La contraseña temporal es: ${env.password}"
                    }
                    """
                }
            }
        }
    }
    post {
        success {
            
            if (currentBuild.result == 'SUCCESS') {
                echo "El proceso ha finalizado."
            }
        }
        aborted {
            echo "El usuario no fueron creados"
            sh "sudo userdel -r ${params.login}"
        }
        failure {
            echo "ERROR, el usuario y grupo fueron eliminado"
            sh "sudo userdel -r ${params.login}"
        }
    }
}
