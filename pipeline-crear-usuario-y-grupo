pipeline {
    agent any
    parameters {
        string(name: 'login', defaultValue: '', description: 'Ingresa el login')
        string(name: 'nombre-apellido', defaultValue: '', description: 'Ingresa el Nombre y Apellido')
        string(name: 'departamento', defaultValue: '', description: 'Ingresa el grupo del usuario')
    }
     environment {
        password = "123456789*"
    }
    stages {
        stage('Crear Usuario y Grupo') {
            steps {
                script {
   
                    def login = params.login
                    def nombreApellido = params.'nombre-apellido'
                    def departamento = params.departamento
                    def message = ""

                    sh """
                        if getent passwd  "$login" > /dev/null 2>&1; then

                           message 'El usuario $login ya existe, no se puede continuar.'
                            
                        else
                                echo 'Creando el usuario: $login'
                                sudo useradd -m -s /bin/bash -c '$nombreApellido' -g $departamento $login
                                echo "$login:${env.password}" | sudo chpasswd
                                sudo passwd -e $login
                             message = "Usuario ${params.login} fue creado con éxito. La contraseña temporal es: ${env.password}"
                        fi
                    """
                }
            }
        }
    }
    post {
        success {
             echo "${message}"
        }
        aborted {
            echo "El usuario no fueron creados"
            sh "sudo userdel -r ${params.login}"
        }
        failure {
            echo "ERROR DE CODIGO, el usuario y grupo fueron eliminado"
            sh "sudo userdel -r ${params.login}"
        }
    }
}
